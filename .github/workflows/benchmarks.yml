name: benchmarks

on:
    pull_request:
    push:
        branches:
            - master
        tags:
          - '*'

jobs:
  cleanup-runs:
    runs-on: ubuntu-latest
    steps:
    - uses: rokroskar/workflow-run-cleanup-action@master
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    if: "!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'"

  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Checkout benchmark
        uses: actions/checkout@v2
        with:
          repository: cvxpy/benchmarks
        
      - name: Install dependencies
        run: |
          pip install .

      - name: Run benchmarks
        run: |
          asv machine --machine GitHubActions
          asv --config asv.conf.json -m GitHubActions
          asv --config asv.conf.json publish

      - name: Deploy HTML Artifacts
        uses: JamesIves/github-pages-deploy-action@v4.2.2
        with:
          folder: html/
          repository-name: parthb83/benchmarks
          branch: gh-pages

