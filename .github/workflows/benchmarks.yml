name: benchmarks

on:
    pull_request:
    push:
        branches:
            - master
        tags:
          - '*'

jobs:
  cleanup-runs:
    runs-on: ubuntu-latest
    steps:
    - uses: rokroskar/workflow-run-cleanup-action@master
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
    if: "!startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/heads/master'"

  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Checkout benchmark
        uses: actions/checkout@v2
        with:
          repository: cvxpy/benchmarks
          ref: main
        
      - name: Install dependencies
        run: |
          pip install .
      
      - name: Checkout deployed branch
        uses: actions/checkout@v2
        with:
          repository: parthb83/benchmarks
          ref: gh-pages
          path: deployed/
      
      - name: Copy contents to html
        run: |
          mkdir html
          cp -a deployed/. html/

      - name: Run benchmarks
        run: |
          asv machine --yes
          asv run --quick
          asv publish
      
      - name: Commit results Artifacts
        uses: actions-js/push@master
        with:
          message: New results published
          branch: results
          directory: results/
          repository: parthb83/benchmarks
          github_token: "${{ secrets.BENCHMARK_DEPLOY_TOKEN }}"

      - name: Deploy HTML Artifacts
        uses: JamesIves/github-pages-deploy-action@v4.2.2
        with:
          folder: html/
          repository-name: parthb83/benchmarks
          branch: gh-pages
          token: "${{ secrets.BENCHMARK_DEPLOY_TOKEN }}"
